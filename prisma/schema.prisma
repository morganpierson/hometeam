datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// ENUMS
// ============================================================================

enum TradeCategory {
  ELECTRICIAN
  PLUMBER
  HVAC
  CARPENTER
  ROOFER
  PAINTER
  MASON
  WELDER
  GENERAL_CONTRACTOR
  LANDSCAPER
  CONCRETE
  DRYWALL
  FLOORING
  GLAZIER
  INSULATION
  IRONWORKER
  SHEET_METAL
  TILE_SETTER
  OTHER
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum Availability {
  AVAILABLE
  ASSIGNED
  UNAVAILABLE
}

enum ProjectStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ClientType {
  RESIDENTIAL
  COMMERCIAL
  GOVERNMENT
  INDUSTRIAL
}

enum PortfolioOwnerType {
  EMPLOYER
  EMPLOYEE
}

enum ParticipantType {
  EMPLOYER
  EMPLOYEE
  CLIENT
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  FILLED
}

enum PayType {
  HOURLY
  SALARY
  PROJECT_BASED
}

// ============================================================================
// EMPLOYEE (Trade Worker)
// ============================================================================

// Employee = Individual trade worker who can be employed by an Employer
model Employee {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  clerkId              String?             @unique
  email                String?             @unique
  firstName            String?
  lastName             String?
  phone                String?
  bio                  String?             @db.Text
  profileImage         String?
  resume               String?
  resumeSummary        String?             @db.Text
  location             String?

  // Trade-specific fields
  tradeCategory        TradeCategory?
  yearsExperience      Int?
  hourlyRate           Decimal?            @db.Decimal(10, 2)
  availability         Availability        @default(AVAILABLE)
  isAvailableForHire   Boolean             @default(false)

  // Verification & trust
  isBackgroundChecked  Boolean             @default(false)
  isInsured            Boolean             @default(false)

  // Ratings (denormalized for performance)
  avgRating            Decimal?            @db.Decimal(3, 2)
  totalReviews         Int                 @default(0)

  // Employment
  employerId           String?
  employer             Employer?           @relation(fields: [employerId], references: [id])
  employmentStart      DateTime?
  employmentEnd        DateTime?
  status               EmployeeStatus      @default(ACTIVE)
  isAdmin              Boolean             @default(false)

  // Relations
  certifications       Certification[]
  ownedPortfolioItems  PortfolioItem[]     @relation("EmployeeOwnedPortfolio")
  contributions        PortfolioItem[]     @relation("PortfolioContributors")
  projectAssignments   Project[]           @relation("ProjectEmployees")
  hireOffers           HireOffer[]
  serviceAreas         ServiceArea[]       @relation("EmployeeServiceAreas")
  reviewsReceived      Review[]            @relation("ReviewSubject")
  reviewsGiven         Review[]            @relation("ReviewAuthor")
  conversations        Conversation[]      @relation("EmployeeConversations")
  messagesSent         Message[]

  // Saved by employers (talent pool)
  savedByEmployers     Employer[]          @relation("EmployerSavedCandidates")

  // References (other employees who can vouch)
  referencesReceived   Employee[]          @relation("EmployeeReferences")
  referencesProvided   Employee[]          @relation("EmployeeReferences")

  deletedAt            DateTime?

  @@index([employerId])
  @@index([tradeCategory])
  @@index([isAvailableForHire])
  @@index([availability])
}

// ============================================================================
// EMPLOYER (Trade Contractor Company)
// ============================================================================

// Employer = Trade contractor company that employs trade workers
model Employer {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  name                 String
  logo                 String?
  website              String?
  description          String?             @db.Text
  size                 String?

  // Contact
  contactEmail         String?
  contactPhone         String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?

  // Verification & trust
  isInsured            Boolean             @default(false)
  insuranceExpiry      DateTime?
  isLicensed           Boolean             @default(false)
  licenseNumber        String?
  licenseExpiry        DateTime?

  // Ratings (denormalized for performance)
  avgRating            Decimal?            @db.Decimal(3, 2)
  totalReviews         Int                 @default(0)

  // Relations
  employees            Employee[]
  specialties          TradeCategory[]
  serviceAreas         ServiceArea[]       @relation("EmployerServiceAreas")
  portfolio            PortfolioItem[]     @relation("EmployerOwnedPortfolio")
  projectAssignments   Project[]           @relation("ProjectEmployers")
  hireOffers           HireOffer[]
  savedCandidates      Employee[]          @relation("EmployerSavedCandidates")
  savedByClients       Client[]            @relation("ClientSavedEmployers")
  reviewsReceived      Review[]            @relation("EmployerReviewSubject")
  conversations        Conversation[]      @relation("EmployerConversations")
  jobPostings          JobPosting[]

  @@index([name])
}

// ============================================================================
// JOB POSTING
// ============================================================================

// JobPosting = A job listing posted by an Employer to find trade workers
model JobPosting {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Basic Info
  title                String
  description          String              @db.Text
  jobType              JobType
  status               JobStatus           @default(DRAFT)

  // Role Requirements
  primaryTrade         TradeCategory
  requiredCertifications String[]
  minYearsExperience   Int?
  maxYearsExperience   Int?

  // Location
  city                 String
  state                String
  zipCode              String?
  isRemote             Boolean             @default(false)

  // Compensation
  payType              PayType
  payRangeMin          Decimal?            @db.Decimal(10, 2)
  payRangeMax          Decimal?            @db.Decimal(10, 2)

  // Benefits (stored as JSON array of strings)
  benefits             String[]

  // Recruiting Contact
  contactName          String?
  contactEmail         String?
  contactPhone         String?

  // Company Info (can override employer defaults)
  companyDescription   String?             @db.Text

  // Ownership
  employerId           String
  employer             Employer            @relation(fields: [employerId], references: [id])

  // Posted by (employee who created the posting)
  postedById           String?

  // Applications
  applications         JobApplication[]

  @@index([employerId])
  @@index([status])
  @@index([primaryTrade])
  @@index([city, state])
}

// JobApplication = An employee's application to a job posting
model JobApplication {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  status               String              @default("pending") // pending, reviewing, interviewed, offered, hired, rejected

  coverLetter          String?             @db.Text
  expectedPay          Decimal?            @db.Decimal(10, 2)

  // Relations
  jobPostingId         String
  jobPosting           JobPosting          @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  applicantId          String
  // Note: applicant relation would link to Employee model

  @@index([jobPostingId])
  @@index([applicantId])
  @@index([status])
}

// ============================================================================
// CLIENT (Project Owner)
// ============================================================================

// Client = Business or individual who owns projects needing trade work
model Client {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  clerkId              String?             @unique

  // For business clients
  companyName          String?
  clientType           ClientType          @default(RESIDENTIAL)

  // Contact info
  contactName          String?
  email                String?             @unique
  phone                String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?

  // Relations
  projects             Project[]
  savedEmployers       Employer[]          @relation("ClientSavedEmployers")
  reviewsGiven         Review[]            @relation("ClientReviewAuthor")
  conversations        Conversation[]      @relation("ClientConversations")

  @@index([clientType])
}

// ============================================================================
// PROJECT (Active Work - Administrative)
// ============================================================================

// Project = Active work item owned by a Client, assigned to Employers/Employees
model Project {
  id                     String            @id @default(uuid())
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  title                  String
  description            String            @db.Text

  // Location
  address                String?
  city                   String?
  state                  String?
  zipCode                String?

  // Budget & Timeline
  budgetMin              Decimal?          @db.Decimal(12, 2)
  budgetMax              Decimal?          @db.Decimal(12, 2)
  startDate              DateTime?
  expectedEndDate        DateTime?
  completedDate          DateTime?

  // Status
  status                 ProjectStatus     @default(DRAFT)

  // Visibility flags (for administrative control)
  visibleToAssignedOnly  Boolean           @default(false)
  allowPortfolioUse      Boolean           @default(true)
  showBudgetToEmployers  Boolean           @default(false)

  // Requirements
  tradeRequirements      TradeCategory[]

  // Ownership
  clientId               String
  client                 Client            @relation(fields: [clientId], references: [id])

  // Assignments
  employers              Employer[]        @relation("ProjectEmployers")
  employees              Employee[]        @relation("ProjectEmployees")

  // Linked portfolio items created from this project
  portfolioItems         PortfolioItem[]   @relation("SourceProject")

  // Conversation about this project
  conversations          Conversation[]

  @@index([clientId])
  @@index([status])
}

// ============================================================================
// PORTFOLIO ITEM (Showcase - Marketing)
// ============================================================================

// PortfolioItem = Completed work showcase, owned by Employer or Employee
model PortfolioItem {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  title                String
  description          String?             @db.Text

  // Location (less specific than Project for privacy)
  city                 String?
  state                String?

  // Media
  coverImage           String?
  images               String[]

  // Categorization
  tradeCategories      TradeCategory[]
  completedDate        DateTime?

  // Social proof
  clientName           String?
  clientTestimonial    String?             @db.Text
  clientRating         Int?

  // Ownership - either Employer OR Employee owns the item
  ownerType            PortfolioOwnerType
  employerId           String?
  employerOwner        Employer?           @relation("EmployerOwnedPortfolio", fields: [employerId], references: [id])
  employeeId           String?
  employeeOwner        Employee?           @relation("EmployeeOwnedPortfolio", fields: [employeeId], references: [id])

  // Contributors - Employees who worked on this (for employer-owned items)
  contributors         Employee[]          @relation("PortfolioContributors")

  // Source tracking - link to platform Project if applicable
  sourceProjectId      String?
  sourceProject        Project?            @relation("SourceProject", fields: [sourceProjectId], references: [id])
  isFromPlatform       Boolean             @default(false)

  @@index([employerId])
  @@index([employeeId])
  @@index([ownerType])
}

// ============================================================================
// CERTIFICATION
// ============================================================================

// Certification = License, certification, or credential held by an Employee
model Certification {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  name                 String
  issuingBody          String?
  licenseNumber        String?
  issuedDate           DateTime?
  expirationDate       DateTime?
  verified             Boolean             @default(false)
  verifiedAt           DateTime?
  documentUrl          String?

  // Owner
  employeeId           String
  employee             Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([expirationDate])
}

// ============================================================================
// SERVICE AREA
// ============================================================================

// ServiceArea = Geographic area where an Employer or Employee operates
model ServiceArea {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  city                 String?
  state                String?
  zipCode              String?
  radiusMiles          Int?

  // Can belong to Employer, Employee, or both
  employers            Employer[]          @relation("EmployerServiceAreas")
  employees            Employee[]          @relation("EmployeeServiceAreas")

  @@index([zipCode])
  @@index([state])
}

// ============================================================================
// HIRE OFFER (Talent Marketplace)
// ============================================================================

// HireOffer = Offer from an Employer to hire an Employee
model HireOffer {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Offer details
  offeredRate          Decimal?            @db.Decimal(10, 2)
  rateType             String?             // "hourly", "salary", "project"
  message              String?             @db.Text
  status               String              @default("pending") // pending, accepted, declined, withdrawn

  // Parties
  employerId           String
  employer             Employer            @relation(fields: [employerId], references: [id])
  employeeId           String
  employee             Employee            @relation(fields: [employeeId], references: [id])

  // Linked conversation
  conversationId       String?             @unique
  conversation         Conversation?       @relation(fields: [conversationId], references: [id])

  respondedAt          DateTime?

  @@index([employerId])
  @@index([employeeId])
  @@index([status])
}

// ============================================================================
// REVIEW
// ============================================================================

// Review = Rating and feedback, can be about Employee or Employer
model Review {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  rating               Int                 // 1-5
  comment              String?             @db.Text

  // Subject of review (Employee OR Employer)
  employeeSubjectId    String?
  employeeSubject      Employee?           @relation("ReviewSubject", fields: [employeeSubjectId], references: [id])
  employerSubjectId    String?
  employerSubject      Employer?           @relation("EmployerReviewSubject", fields: [employerSubjectId], references: [id])

  // Author of review (Employee OR Client)
  employeeAuthorId     String?
  employeeAuthor       Employee?           @relation("ReviewAuthor", fields: [employeeAuthorId], references: [id])
  clientAuthorId       String?
  clientAuthor         Client?             @relation("ClientReviewAuthor", fields: [clientAuthorId], references: [id])

  @@index([employeeSubjectId])
  @@index([employerSubjectId])
}

// ============================================================================
// MESSAGING
// ============================================================================

// Conversation = Thread between any two parties
model Conversation {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Participants (flexible - any combination)
  employers            Employer[]          @relation("EmployerConversations")
  employees            Employee[]          @relation("EmployeeConversations")
  clients              Client[]            @relation("ClientConversations")

  // Optional context
  projectId            String?
  project              Project?            @relation(fields: [projectId], references: [id])

  // Messages
  messages             Message[]

  // Linked offer (if this conversation is about a hire offer)
  hireOffer            HireOffer?

  @@index([projectId])
}

// Message = Individual message in a conversation
model Message {
  id                   String              @id @default(uuid())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  content              String              @db.Text
  readAt               DateTime?

  // Sender info
  senderId             String
  senderType           ParticipantType

  // For employee senders, link directly
  employeeSender       Employee?           @relation(fields: [senderId], references: [id])

  // Conversation
  conversationId       String
  conversation         Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}

// ============================================================================
// JUNCTION TABLES (Prisma auto-generates, but explicit for clarity)
// ============================================================================

// Note: Prisma will auto-generate implicit many-to-many tables for:
// - Employer <-> TradeCategory (specialties)
// - Project <-> TradeCategory (tradeRequirements)
// - PortfolioItem <-> TradeCategory (tradeCategories)
// - Project <-> Employer (ProjectEmployers)
// - Project <-> Employee (ProjectEmployees)
// - PortfolioItem <-> Employee (PortfolioContributors)
// - Employer <-> ServiceArea
// - Employee <-> ServiceArea
// - Employee <-> Employee (references)
// - Employer <-> Employee (savedCandidates)
// - Client <-> Employer (savedEmployers)
// - Conversation participants
